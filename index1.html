<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AAISM Practice Exam</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body{font-family:'Inter',sans-serif}
.option-btn{transition:.2s}
.selected{background:#e0e7ff;border-color:#6366f1}
.correct{background:#d1fae5;border-color:#10b981}
.incorrect{background:#fee2e2;border-color:#ef4444}
</style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-3xl">

<!-- Landing -->
<div id="landing">
<h1 class="text-3xl font-bold text-center mb-6">AAISM Practice Exam</h1>

<button onclick="goQuiz()" class="w-full bg-indigo-600 text-white p-3 rounded mb-3">
Take Exam
</button>

<button onclick="goAdmin()" class="w-full bg-gray-600 text-white p-3 rounded">
Admin Panel
</button>
</div>

<!-- Quiz -->
<div id="quiz" class="hidden">

<div id="startPage">

<h2 class="text-2xl font-bold mb-4 text-center" id="examTitle">Loading...</h2>

<input id="candidateName" placeholder="Enter Full Name"
class="w-full border p-3 rounded mb-4">

<button onclick="startExam()" class="w-full bg-indigo-600 text-white p-3 rounded">
Start Exam
</button>

</div>

<div id="examArea" class="hidden">

<div class="text-center text-lg font-semibold text-indigo-600 mb-2" id="candidateDisplay"></div>

<div class="flex justify-between mb-3">
<div id="qNumber"></div>
<div id="timer">00:00</div>
</div>

<div id="questionText" class="text-lg mb-4"></div>

<div id="options"></div>

<button onclick="nextQ()" class="mt-5 w-full bg-gray-800 text-white p-3 rounded">
Next
</button>

</div>

<div id="result" class="hidden text-center">
<h2 class="text-2xl font-bold mb-4">Exam Completed</h2>
<div id="scoreText" class="mb-4"></div>

<button onclick="downloadPDF()" class="bg-green-600 text-white p-3 rounded w-full">
Download PDF
</button>

<button onclick="restart()" class="bg-indigo-600 text-white p-3 rounded w-full mt-2">
Restart
</button>
</div>

</div>

</div>

<script>

/* ================= STATE ================= */

let questions=[]
let candidate=""
let index=0
let answers=[]
let score=0
let timer
let timeLeft=0

/* ================= FIREBASE ================= */

firebase.initializeApp({
apiKey:"AIzaSyAfdPoi...",
authDomain:"cissp-c35cd.firebaseapp.com",
projectId:"cissp-c35cd"
})

const db=firebase.firestore()

firebase.auth().signInAnonymously()

const quizRef=db.collection("quizzes").doc("main")
const historyRef=db.collection("history")

quizRef.onSnapshot(doc=>{
if(doc.exists){
questions=JSON.parse(doc.data().questionsJSON)
document.getElementById("examTitle").innerText=doc.data().title
}
})

/* ================= ROUTING ================= */

function goQuiz(){
document.getElementById("landing").classList.add("hidden")
document.getElementById("quiz").classList.remove("hidden")
}

function goAdmin(){
alert("Admin Panel not included in this lite build")
}

/* ================= EXAM ================= */

function startExam(){

candidate=document.getElementById("candidateName").value.trim()

if(!candidate){
alert("Enter name")
return
}

document.getElementById("candidateDisplay").innerText=candidate

document.getElementById("startPage").classList.add("hidden")
document.getElementById("examArea").classList.remove("hidden")

index=0
answers=[]
score=0

timeLeft=questions.length*60

timer=setInterval(()=>{
timeLeft--
document.getElementById("timer").innerText=
Math.floor(timeLeft/60)+":"+String(timeLeft%60).padStart(2,'0')

if(timeLeft<=0) finish()
},1000)

showQ()
}

function showQ(){

let q=questions[index]

document.getElementById("qNumber").innerText=
`Question ${index+1}/${questions.length}`

document.getElementById("questionText").innerText=q.question

let optHTML=""

q.options.forEach((o,i)=>{
optHTML+=`
<button onclick="select(${i})"
class="option-btn w-full border p-3 rounded mb-2 text-left">
${o}
</button>`
})

document.getElementById("options").innerHTML=optHTML
}

function select(i){
answers[index]=i
}

function nextQ(){
index++
if(index>=questions.length) finish()
else showQ()
}

async function finish(){

clearInterval(timer)

score=questions.reduce((a,q,i)=>{
let correct=q.answer.charCodeAt(0)-65
return a+(answers[i]===correct?1:0)
},0)

document.getElementById("examArea").classList.add("hidden")
document.getElementById("result").classList.remove("hidden")

document.getElementById("scoreText").innerText=
`${candidate} Score: ${score}/${questions.length}`

await historyRef.add({
candidateName:candidate,
score:score,
total:questions.length,
date:new Date().toISOString()
})
}

/* ================= PDF ================= */

function downloadPDF(){

const {jsPDF}=window.jspdf
const doc=new jsPDF()

doc.text("AAISM Exam Result",20,20)
doc.text("Candidate: "+candidate,20,35)
doc.text("Score: "+score+"/"+questions.length,20,45)

doc.save("result.pdf")
}

function restart(){
location.reload()
}

</script>

</body>
</html>

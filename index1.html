<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AAISM Practice Exam - Candidate Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .option-btn { transition: all 0.2s; }
        .selected { background-color: #e0e7ff !important; border-color: #6366f1 !important; }
        .correct { background-color: #d1fae5 !important; border-color: #10b981 !important; }
        .incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg w-full max-w-3xl relative">
        
        <div id="landing-page" class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">AAISM Practice Exam 2026</h1>
            <div class="space-y-4">
                 <a href="#quiz" class="block w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">Take the Quiz</a>
                 <a href="#admin" class="block w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-transform transform hover:scale-105">Admin Panel</a>
            </div>
        </div>

        <div id="password-page" class="hidden text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Admin Access</h1>
            <input type="password" id="password-input" class="w-full p-2 border border-gray-300 rounded-lg mb-4" placeholder="Password">
            <p id="password-error" class="text-red-500 text-sm h-5 mb-4"></p>
            <button id="password-submit-btn" class="w-full bg-indigo-600 text-white py-2 px-3 rounded-lg hover:bg-indigo-700">Submit</button>
            <a href="#" class="mt-4 block text-indigo-600 hover:underline">Back</a>
        </div>

        <div id="admin-menu-page" class="hidden text-center">
            <h1 class="text-2xl font-bold mb-4">Admin Menu</h1>
            <div class="space-y-4">
                <a href="#exam-management" class="block w-full bg-indigo-600 text-white py-3 px-4 rounded-lg">Management</a>
                <a href="#exam-history" class="block w-full bg-gray-600 text-white py-3 px-4 rounded-lg">View History</a>
                <a href="#" class="mt-8 block text-indigo-600">Logout</a>
            </div>
        </div>

        <div id="exam-history-page" class="hidden">
            <h2 class="text-xl font-bold mb-4">Candidate Results History</h2>
            <div id="history-list" class="max-h-96 overflow-y-auto"></div>
            <a href="#admin-menu" class="mt-4 block text-center bg-gray-200 p-2 rounded">Back</a>
        </div>

        <div id="quiz-page" class="hidden">
            <div id="start-page" class="text-center">
                <h1 id="quiz-title" class="text-2xl font-bold mb-4">Exam Loading...</h1>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Candidate Full Name</label>
                    <input type="text" id="candidate-name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Adarsh S">
                </div>
                <button id="start-exam-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-gray-400">
                    Start Examination
                </button>
            </div>

            <div id="question-area" class="hidden">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <div>
                        <span class="text-indigo-600 font-bold" id="display-candidate-name"></span>
                        <div id="question-number" class="text-sm text-gray-500"></div>
                    </div>
                    <div id="timer" class="text-2xl font-mono font-bold text-red-500">00:00</div>
                </div>
                <p id="question-text" class="text-gray-800 text-lg mb-6"></p>
                <div id="options-container" class="space-y-3"></div>
                <button id="next-btn" class="mt-8 w-full bg-gray-800 text-white py-3 rounded-lg disabled:bg-gray-400" disabled>Next Question</button>
            </div>

            <div id="result-area" class="hidden text-center">
                <h2 class="text-2xl font-bold mb-2">Exam Result</h2>
                <p id="final-candidate-name" class="text-lg font-semibold text-indigo-600 mb-4"></p>
                <p id="score-text" class="text-3xl font-bold mb-6"></p>
                <div class="space-y-3">
                    <button id="download-btn" class="w-full bg-green-600 text-white py-3 rounded-lg">Download PDF Certificate</button>
                    <button onclick="location.reload()" class="w-full bg-indigo-100 text-indigo-700 py-3 rounded-lg">Return Home</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let questions = [];
        let currentIdx = 0;
        let userAnswers = [];
        let score = 0;
        let timer;
        let timeLeft = 0;
        let candidateName = "";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAfdPoiIZH7hGhnMKtFGrzuqOa4AN6WCZI",
            authDomain: "cissp-c35cd.firebaseapp.com",
            projectId: "cissp-c35cd"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Auto-login
        firebase.auth().signInAnonymously();

        const quizDoc = db.collection('artifacts').doc('default').collection('public').doc('data').collection('quizzes').doc('main');
        const historyCol = db.collection('artifacts').doc('default').collection('public').doc('data').collection('history');

        // Load Quiz Data
        quizDoc.onSnapshot(doc => {
            if(doc.exists) {
                questions = JSON.parse(doc.data().questionsJSON);
                document.getElementById('quiz-title').innerText = doc.data().title || "AAISM Exam";
            }
        });

        // --- Routing ---
        function router() {
            const hash = window.location.hash;
            const pages = ['landing-page', 'password-page', 'admin-menu-page', 'quiz-page', 'exam-history-page'];
            pages.forEach(p => document.getElementById(p).classList.add('hidden'));

            if(hash === '#quiz') document.getElementById('quiz-page').classList.remove('hidden');
            else if(hash === '#admin') document.getElementById('password-page').classList.remove('hidden');
            else if(hash === '#admin-menu') document.getElementById('admin-menu-page').classList.remove('hidden');
            else if(hash === '#exam-history') {
                document.getElementById('exam-history-page').classList.remove('hidden');
                loadHistory();
            }
            else document.getElementById('landing-page').classList.remove('hidden');
        }
        window.addEventListener('hashchange', router);

        // --- Quiz Logic ---
        document.getElementById('start-exam-btn').onclick = () => {
            candidateName = document.getElementById('candidate-name').value.trim();
            if(!candidateName) return alert("Please enter your name");
            
            document.getElementById('display-candidate-name').innerText = candidateName;
            document.getElementById('start-page').classList.add('hidden');
            document.getElementById('question-area').classList.remove('hidden');
            
            startQuiz();
        };

        function startQuiz() {
            currentIdx = 0;
            userAnswers = [];
            timeLeft = questions.length * 60;
            startTimer();
            showQuestion();
        }

        function showQuestion() {
            const q = questions[currentIdx];
            document.getElementById('question-number').innerText = `Question ${currentIdx + 1} of ${questions.length}`;
            document.getElementById('question-text').innerText = q.question;
            
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            q.options.forEach((opt, i) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-4 border-2 rounded-lg hover:bg-gray-50";
                btn.innerText = opt;
                btn.onclick = () => {
                    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    userAnswers[currentIdx] = i;
                    document.getElementById('next-btn').disabled = false;
                };
                container.appendChild(btn);
            });
            document.getElementById('next-btn').disabled = true;
        }

        document.getElementById('next-btn').onclick = () => {
            currentIdx++;
            if(currentIdx < questions.length) showQuestion();
            else finishQuiz();
        };

        async function finishQuiz() {
            clearInterval(timer);
            score = questions.reduce((acc, q, i) => {
                const correctIdx = q.answer.charCodeAt(0) - 65;
                return acc + (userAnswers[i] === correctIdx ? 1 : 0);
            }, 0);

            const percent = Math.round((score/questions.length)*100);
            
            document.getElementById('question-area').classList.add('hidden');
            document.getElementById('result-area').classList.remove('hidden');
            document.getElementById('final-candidate-name').innerText = candidateName;
            document.getElementById('score-text').innerText = `${score} / ${questions.length} (${percent}%)`;

            // Save to History
            await historyCol.add({
                candidate: candidateName,
                score: score,
                total: questions.length,
                percentage: percent,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function startTimer() {
            timer = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft/60);
                const secs = timeLeft%60;
                document.getElementById('timer').innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                if(timeLeft <= 0) finishQuiz();
            }, 1000);
        }

        // --- PDF Generation ---
        document.getElementById('download-btn').onclick = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(22);
            doc.text("Examination Certificate", 105, 40, { align: "center" });
            
            doc.setFontSize(16);
            doc.text(`Candidate: ${candidateName}`, 20, 70);
            doc.text(`Exam: ${document.getElementById('quiz-title').innerText}`, 20, 80);
            doc.text(`Score: ${score} / ${questions.length}`, 20, 90);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 100);
            
            doc.save(`${candidateName}_Result.pdf`);
        };

        // --- Admin/History ---
        function loadHistory() {
            historyCol.orderBy('timestamp', 'desc').get().then(snap => {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = "p-3 border-b text-sm flex justify-between";
                    div.innerHTML = `<span><b>${data.candidate}</b></span> <span>${data.score}/${data.total} (${data.percentage}%)</span>`;
                    list.appendChild(div);
                });
            });
        }

        document.getElementById('password-submit-btn').onclick = () => {
            if(document.getElementById('password-input').value === "Legacy@2025") {
                window.location.hash = "#admin-menu";
            } else {
                alert("Wrong password");
            }
        };

        router(); // Init
    </script>
</body>
</html>

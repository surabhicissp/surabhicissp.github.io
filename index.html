<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CISSP Practice Exam - Surabhi Sadasivan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Standard Firebase SDK imports for better compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .option-btn {
            transition: background-color 0.2s, border-color 0.2s;
        }
        .selected {
            background-color: #e0e7ff !important;
            border-color: #6366f1 !important;
        }
        .correct {
            background-color: #d1fae5 !important;
            border-color: #10b981 !important;
        }
        .incorrect {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
        }
        .review-question-container {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin-bottom: 2rem;
        }
        .review-user-answer.correct {
             border-color: #10b981;
        }
        .review-user-answer.incorrect {
             border-color: #ef4444;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="bg-white p-6 md:p-8 rounded-2xl shadow-lg w-full max-w-3xl relative">
        
        <!-- Landing Page -->
        <div id="landing-page" class="text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">CISSP Practice Exam 2025 - Surabhi Sadasivan</h1>
            <p class="text-gray-600 mb-8">Welcome! Please choose an option below.</p>
            <div class="space-y-4">
                 <a href="#quiz" class="block w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-105">Take the Quiz</a>
                 <a href="#admin" class="block w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition-transform transform hover:scale-105">Go to Admin Panel</a>
            </div>
        </div>

        <!-- Password Page -->
        <div id="password-page" class="hidden text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Admin Access</h1>
            <p class="text-gray-600 mb-4">Please enter the password to continue.</p>
            <input type="password" id="password-input" class="w-full p-2 border border-gray-300 rounded-lg mb-4" placeholder="Password">
            <p id="password-error" class="text-red-500 text-sm h-5 mb-4"></p>
            <button id="password-submit-btn" class="w-full bg-indigo-600 text-white py-2 px-3 rounded-lg hover:bg-indigo-700">Submit</button>
            <a href="#" class="mt-4 block text-center text-indigo-600 hover:underline">Back to Main Menu</a>
        </div>

        <!-- Admin Main Menu -->
        <div id="admin-menu-page" class="hidden text-center">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Admin Main Menu</h1>
            <div class="space-y-4">
                <a href="#exam-management" class="block w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700">Exam Management</a>
                <a href="#exam-history" class="block w-full bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700">Exam History</a>
                <a href="#" class="mt-8 block text-center text-indigo-600 hover:underline">Back to Main Menu</a>
            </div>
        </div>

        <!-- Admin Page: Exam Management -->
        <div id="exam-management-page" class="hidden">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 text-center">Exam Management</h1>
            <div class="mt-8 pt-6 border-t border-gray-200">
                <p id="question-load-status" class="text-sm text-center text-green-600 mb-4 h-5"></p>

                <div class="mb-4 text-left">
                    <label for="exam-title-input" class="block text-sm font-medium text-gray-700 mb-1">Exam Title:</label>
                    <input type="text" id="exam-title-input" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="e.g., CISSP Domain 1 Practice Exam">
                </div>

                <div class="mb-4 text-left">
                    <label for="file-upload" class="block text-sm font-medium text-gray-700 mb-1">Load from JSON file:</label>
                    <input type="file" id="file-upload" accept=".json" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer"/>
                </div>

                <div class="mb-4 text-left">
                     <label for="json-textarea" class="block text-sm font-medium text-gray-700 mb-1">Or paste JSON here:</label>
                     <textarea id="json-textarea" rows="5" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="[{...}]"></textarea>
                     <button id="load-text-btn" class="mt-2 w-full bg-gray-600 text-white py-2 px-3 rounded-lg hover:bg-gray-700 disabled:bg-gray-400" disabled>Load from Text</button>
                </div>
                
                <div class="text-xs text-gray-500 text-left mb-4 p-2 bg-gray-50 rounded">
                    <p><strong>Required Format:</strong> An array of objects. The `answer` field can be the choice letter (e.g., "A") or the full answer text.</p>
                </div>
                
                <div class="mt-6 pt-6 border-t border-dashed">
                    <button id="flush-questions-btn" class="w-full bg-red-500 text-white py-2 px-3 rounded-lg hover:bg-red-600 disabled:bg-red-300" disabled>Clear Custom Questions</button>
                    <p class="text-xs text-center mt-2 text-gray-500">This will revert the quiz to the default questions.</p>
                </div>
                 <a href="#admin-menu" class="mt-8 block w-full bg-gray-200 text-gray-800 py-2 px-3 rounded-lg hover:bg-gray-300 text-center">Back to Admin Menu</a>
            </div>
        </div>
        
        <!-- Admin Page: Exam History -->
        <div id="exam-history-page" class="hidden">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4 text-center">Exam History</h1>
            <div id="exam-history-container" class="max-h-96 overflow-y-auto">
                <p class="text-center text-gray-500">No exam history found.</p>
            </div>
             <div class="mt-6 pt-6 border-t border-dashed">
                <button id="clear-history-btn" class="w-full bg-red-500 text-white py-2 px-3 rounded-lg hover:bg-red-600 disabled:bg-red-300" disabled>Clear Exam History</button>
            </div>
            <a href="#admin-menu" class="mt-8 block w-full bg-gray-200 text-gray-800 py-2 px-3 rounded-lg hover:bg-gray-300 text-center">Back to Admin Menu</a>
        </div>


        <!-- Quiz Page Wrapper -->
        <div id="quiz-page" class="hidden">
            <div id="start-page" class="text-center">
                <h1 id="quiz-title" class="text-2xl md:text-3xl font-bold text-gray-800 mb-4"></h1>
                <div id="datetime-display" class="text-gray-500 text-sm mb-8"></div>
                <p id="start-page-intro" class="text-gray-600 mb-8">Loading questions...</p>
                <button id="start-exam-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105" disabled>
                    Start Exam
                </button>
                 <a href="#" class="mt-8 block text-center text-indigo-600 hover:underline">Back to Main Menu</a>
            </div>

            <div id="question-area" class="hidden mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="question-number" class="text-lg font-semibold text-gray-700"></h2>
                    <div id="timer" class="text-3xl font-mono font-bold text-indigo-600">00:00:00</div>
                </div>
                <p id="question-text" class="text-gray-800 text-lg mb-6"></p>
                <div id="options-container" class="space-y-3"></div>
            </div>

            <div id="result-area" class="hidden text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Exam Completed!</h2>
                <p id="score-text" class="text-xl text-gray-600 mb-2"></p>
                <p id="feedback-text" class="text-lg font-semibold mb-6"></p>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                    <button id="restart-btn" class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700">Restart Exam</button>
                    <button id="review-btn" class="w-full bg-gray-700 text-white py-3 px-4 rounded-lg hover:bg-gray-800">Review Answers</button>
                    <button id="download-btn" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700">Download Results (PDF)</button>
                </div>
                 <a href="#" class="mt-8 block text-center text-indigo-600 hover:underline">Back to Main Menu</a>
            </div>

            <div id="review-area" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Answer Review</h2>
                    <button id="back-to-score-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">Back to Score</button>
                </div>
                <div id="review-content" class="space-y-8 max-h-[70vh] overflow-y-auto pr-4"></div>
            </div>

            <div id="navigation-area" class="hidden">
                <div class="mt-8 flex justify-between items-center">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <button id="next-btn" class="mt-6 w-full bg-gray-800 text-white py-3 px-4 rounded-lg hover:bg-gray-900 disabled:bg-gray-400" disabled>Next Question</button>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const defaultQuestions = [
            // Default 15 questions remain here...
            { question: "Which of the following BEST describes the principle of 'Confidentiality' in the CIA triad?", options: ["Data is accurate and has not been tampered with.", "Systems and data are accessible when needed.", "Information is protected from unauthorized disclosure.", "Users can be held accountable for their actions."], answer: "C", explanation: "Confidentiality ensures that sensitive information is not disclosed to unauthorized individuals, entities, or processes.", distractors: { A: "This describes Integrity.", B: "This describes Availability.", D: "This describes Accountability." } },
            { question: "According to the (ISC)² Code of Ethics, which canon holds the highest priority?", options: ["Act honorably, honestly, justly, responsibly, and legally.", "Provide diligent and competent service to principals.", "Advance and protect the profession.", "Protect society, the common good, necessary public trust and confidence, and the infrastructure."], answer: "D", explanation: "The (ISC)² Code of Ethics is ordered by priority. The first canon, 'Protect society, the common good...', is the most important and takes precedence over all others.", distractors: { A: "This is the second canon.", B: "This is the third canon.", C: "This is the fourth canon."} },
            { question: "A company's security policy states that all employees must use strong passwords. A separate document specifies that passwords must be at least 12 characters long and include a mix of character types. This separate document is an example of a:", options: ["Procedure", "Guideline", "Standard", "Policy"], answer: "C", explanation: "A Standard provides mandatory, specific requirements to support a policy.", distractors: { A: "A procedure gives step-by-step instructions.", B: "A guideline offers recommendations or best practices.", D: "A policy is a high-level statement of intent."} },
            { question: "An organization identifies a critical server has a value of $200,000. It is estimated that a specific threat will occur once every five years, and its successful exploitation would result in a 25% loss of the server's value. What is the Annualized Loss Expectancy (ALE)?", options: ["$10,000", "$50,000", "$25,000", "$100,000"], answer: "A", explanation: "First, calculate the Single Loss Expectancy (SLE): Asset Value ($200,000) * Exposure Factor (0.25) = $50,000. Next, calculate the Annualized Rate of Occurrence (ARO): 1 occurrence / 5 years = 0.2. Finally, calculate the ALE: SLE ($50,000) * ARO (0.2) = $10,000.", distractors: { B: "$50,000 is the SLE, not the ALE.", C: "This is an incorrect calculation.", D: "This is an incorrect calculation."} },
            { question: "What is the PRIMARY purpose of a Business Impact Analysis (BIA)?", options: ["To identify and analyze threats to the organization.", "To select appropriate security controls.", "To determine the criticality of business processes and the impact of their disruption.", "To create a step-by-step plan for disaster recovery."], answer: "C", explanation: "The BIA is the foundational step in business continuity planning. Its main goal is to identify critical business functions and quantify the impact that a disruption to those functions would cause.", distractors: { A: "This is part of a risk assessment.", B: "This is part of risk treatment.", D: "This is the purpose of a DRP."} },
            { question: "An organization decides to purchase cybersecurity insurance to cover potential losses from a data breach. This is an example of which risk response strategy?", options: ["Risk Mitigation", "Risk Acceptance", "Risk Avoidance", "Risk Transference"], answer: "D", explanation: "Risk Transference (or transfer) involves shifting the financial impact of a risk to a third party, such as an insurance company.", distractors: { A: "Mitigation would involve implementing controls to reduce the risk.", B: "Acceptance would involve acknowledging the risk and not taking action.", C: "Avoidance would involve stopping the activity causing the risk."} },
            { question: "Which of the following is a personnel security control designed primarily to detect fraudulent or malicious activity by requiring another employee to perform the duties of a critical role?", options: ["Separation of Duties", "Least Privilege", "Mandatory Vacation", "Background Checks"], answer: "C", explanation: "Mandatory vacations force an employee to be away from their role for a period, allowing others to perform their duties. This can often uncover irregularities or fraudulent activities that the original employee was concealing.", distractors: { A: "Separation of duties prevents a single person from completing a critical task alone.", B: "Least privilege limits access to only what is necessary.", D: "Background checks are a pre-employment screening control."} },
            { question: "The European Union's General Data Protection Regulation (GDPR) is primarily concerned with:", options: ["Protecting the health information of individuals.", "Standardizing security controls for government agencies.", "Protecting the fundamental rights and freedoms of natural persons, particularly their right to data protection.", "Securing credit card transaction data."], answer: "C", explanation: "GDPR is a comprehensive data protection law that grants individuals significant rights over their personal data and imposes strict obligations on organizations that collect, process, or store it.", distractors: { A: "This is the focus of HIPAA.", B: "This is the focus of frameworks like NIST.", D: "This is the focus of PCI DSS."} },
            { question: "The act of performing research, reading security best practices, and staying up-to-date on emerging threats to ensure a security program is properly implemented is an example of:", options: ["Due Care", "Due Diligence", "Due Process", "Negligence"], answer: "B", explanation: "Due Diligence is the investigative, research-oriented part of ensuring security.", distractors: { A: "Due care is the action of maintaining the controls.", C: "Due process is a legal principle.", D: "Negligence is the failure to exercise due care."} },
            { question: "Which document is tactical in nature and focuses on restoring IT systems and infrastructure at an alternate site after a major disruption?", options: ["Business Continuity Plan (BCP)", "Business Impact Analysis (BIA)", "Disaster Recovery Plan (DRP)", "Security Policy"], answer: "C", explanation: "A DRP is a subset of the overall BCP. While the BCP is strategic and focuses on keeping the business operational, the DRP is tactical and provides the detailed procedures to recover the technological capabilities.", distractors: { A: "A BCP is a strategic plan for the entire business.", B: "A BIA is an analysis, not a plan.", D: "A security policy is a high-level document of intent."} },
            { question: "A company wants to classify its data based on the potential damage that an unauthorized disclosure would cause. Which of the following would be the MOST appropriate label for data that, if disclosed, could cause exceptionally grave damage to national security?", options: ["Confidential", "Private", "Sensitive", "Top Secret"], answer: "D", explanation: "This question uses the government classification scheme. 'Top Secret' is the highest level, reserved for information that could cause 'exceptionally grave damage.' 'Confidential' is typically the lowest level in this model.", distractors: { A: "Confidential is a lower level of classification.", B: "Private is a commercial classification.", C: "Sensitive is a commercial classification."} },
            { question: "What is the main goal of security governance?", options: ["To purchase the latest security technology.", "To ensure that security strategies are aligned with business objectives and regulatory requirements.", "To perform daily monitoring of security alerts.", "To achieve 100% compliance with all security frameworks."], answer: "B", explanation: "Security governance provides the strategic framework for an organization's security efforts, ensuring that they support business goals, manage risk effectively, and comply with all relevant laws and regulations.", distractors: { A: "This is a tactical decision, not a governance goal.", C: "This is an operational task.", D: "Compliance is a goal, but alignment with business objectives is the main goal."} },
            { question: "The STRIDE threat model is often used to identify threats in software development. What does the 'S' in STRIDE stand for?", options: ["Spoofing", "Security", "Standard", "System"], answer: "A", explanation: "STRIDE is a mnemonic for six categories of threats: Spoofing, Tampering, Repudiation, Information Disclosure, Denial of Service, and Elevation of Privilege.", distractors: { B: "Security is the overall goal, not a threat category.", C: "Standard is not part of STRIDE.", D: "System is not part of STRIDE."} },
            { question: "Which of the following is a qualitative risk assessment approach?", options: ["Calculating the Annualized Loss Expectancy (ALE).", "Using a high, medium, and low scale to rank risks.", "Determining the Single Loss Expectancy (SLE).", "Calculating the return on security investment (ROSI)."], answer: "B", explanation: "Qualitative risk assessment uses subjective measures and descriptive scales (like high, medium, low) to evaluate risk.", distractors: { A: "ALE is a quantitative measure.", C: "SLE is a quantitative measure.", D: "ROSI is a quantitative measure."} },
            { question: "A security awareness program is MOST effective when it is:", options: ["Conducted once a year for all employees.", "Focused only on the IT department.", "A continuous process that is regularly updated and reinforced.", "Based on highly technical and complex security concepts."], answer: "C", explanation: "Effective security awareness is not a one-time event. It requires ongoing training, reinforcement, and updates to keep pace with changing threats and to keep security top-of-mind for all employees.", distractors: { A: "Once a year is not frequent enough.", B: "Security is everyone's responsibility, not just IT.", D: "Awareness should be accessible, not overly technical."} }
        ];

        // --- State Variables ---
        let loadedQuestions = [];
        let loadedTitle = "CISSP Domain 1 Practice Exam - Surabhi Sadasivan";
        let currentQuestionIndex = 0;
        let score = 0;
        let examTimer;
        let totalTimeLeft;
        let userAnswers = [];
        let shuffledQuestions = [];

        // --- Firebase State ---
        let db;
        let questionsDocRef;
        let historyCollectionRef;
        let isDbReady = false;

        // --- DOM Elements ---
        const landingPageEl = document.getElementById('landing-page');
        const adminPageEl = document.getElementById('admin-page');
        const passwordPageEl = document.getElementById('password-page');
        const adminMenuPageEl = document.getElementById('admin-menu-page');
        const examManagementPageEl = document.getElementById('exam-management-page');
        const examHistoryPageEl = document.getElementById('exam-history-page');
        const quizPageEl = document.getElementById('quiz-page');
        const startPageEl = document.getElementById('start-page');
        const startExamBtn = document.getElementById('start-exam-btn');
        const questionNumberEl = document.getElementById('question-number');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainerEl = document.getElementById('options-container');
        const nextBtn = document.getElementById('next-btn');
        const progressBar = document.getElementById('progress-bar');
        const resultAreaEl = document.getElementById('result-area');
        const questionAreaEl = document.getElementById('question-area');
        const scoreTextEl = document.getElementById('score-text');
        const feedbackTextEl = document.getElementById('feedback-text');
        const restartBtn = document.getElementById('restart-btn');
        const reviewBtn = document.getElementById('review-btn');
        const downloadBtn = document.getElementById('download-btn');
        const timerEl = document.getElementById('timer');
        const reviewAreaEl = document.getElementById('review-area');
        const reviewContentEl = document.getElementById('review-content');
        const backToScoreBtn = document.getElementById('back-to-score-btn');
        const navigationArea = document.getElementById('navigation-area');
        const datetimeDisplay = document.getElementById('datetime-display');
        const startPageIntroEl = document.getElementById('start-page-intro');
        const questionLoadStatusEl = document.getElementById('question-load-status');
        const fileUploadEl = document.getElementById('file-upload');
        const jsonTextareaEl = document.getElementById('json-textarea');
        const loadTextBtn = document.getElementById('load-text-btn');
        const flushQuestionsBtn = document.getElementById('flush-questions-btn');
        const passwordInputEl = document.getElementById('password-input');
        const passwordSubmitBtn = document.getElementById('password-submit-btn');
        const passwordErrorEl = document.getElementById('password-error');
        const examTitleInputEl = document.getElementById('exam-title-input');
        const quizTitleEl = document.getElementById('quiz-title');
        const examHistoryContainerEl = document.getElementById('exam-history-container');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        
        // --- Firebase Setup ---
        function setupFirebase() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyAfdPoiIZH7hGhnMKtFGrzuqOa4AN6WCZI",
                  authDomain: "cissp-c35cd.firebaseapp.com",
                  projectId: "cissp-c35cd",
                  storageBucket: "cissp-c35cd.appspot.com",
                  messagingSenderId: "573038813376",
                  appId: "1:573038813376:web:5285ea4d043186bf2ccd25",
                  measurementId: "G-GZF1ZNH3RR"
                };
                
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                questionsDocRef = db.collection('quizzes').doc('cissp_domain_1');
                historyCollectionRef = db.collection('history');

                questionsDocRef.onSnapshot((docSnap) => {
                    const data = docSnap.data();
                    if (docSnap.exists && data && data.questionsJSON) {
                        try {
                            loadedQuestions = JSON.parse(data.questionsJSON);
                            loadedTitle = data.title || "CISSP Domain 1 Practice Exam - Surabhi Sadasivan";
                        } catch (e) {
                            console.error("Error parsing questions from DB, using defaults.", e);
                            loadedQuestions = [...defaultQuestions];
                            loadedTitle = "CISSP Domain 1 Practice Exam - Surabhi Sadasivan";
                        }
                    } else {
                        loadedQuestions = [...defaultQuestions];
                        loadedTitle = "CISSP Domain 1 Practice Exam - Surabhi Sadasivan";
                    }
                    if (window.location.hash === '#quiz') {
                         updateStartPageUI();
                    }
                    startExamBtn.disabled = false;
                }, (error) => {
                    console.error("Firestore listener error:", error);
                    loadedQuestions = [...defaultQuestions];
                    updateStartPageUI();
                    startExamBtn.disabled = false;
                });
                
                historyCollectionRef.orderBy("date", "desc").onSnapshot(snapshot => {
                    const history = [];
                    snapshot.forEach(doc => {
                        history.push(doc.data());
                    });
                    displayExamHistory(history);
                });

                isDbReady = true;
                loadTextBtn.disabled = false;
                flushQuestionsBtn.disabled = false;
                clearHistoryBtn.disabled = false;
                updateAdminStatus("Database connected.", false);

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadedQuestions = [...defaultQuestions];
                updateStartPageUI();
                updateAdminStatus(`Database connection failed. Using defaults.`, true);
                startExamBtn.disabled = false;
                isDbReady = false;
            }
        }

        // --- Routing ---
        function router() {
            const allPages = [landingPageEl, quizPageEl, passwordPageEl, adminMenuPageEl, examManagementPageEl, examHistoryPageEl];
            allPages.forEach(p => p.classList.add('hidden'));

            const hash = window.location.hash;

            if (hash === '#admin') {
                passwordPageEl.classList.remove('hidden');
            } else if (hash === '#admin-menu') {
                adminMenuPageEl.classList.remove('hidden');
            } else if (hash === '#exam-management') {
                examManagementPageEl.classList.remove('hidden');
            } else if (hash === '#exam-history') {
                examHistoryPageEl.classList.remove('hidden');
            } else if (hash === '#quiz') {
                quizPageEl.classList.remove('hidden');
                initializeQuiz();
            } else {
                landingPageEl.classList.remove('hidden');
            }
        }

        // --- Core Quiz Functions ---
        function initializeQuiz() {
            clearInterval(examTimer);
            questionAreaEl.classList.add('hidden');
            navigationArea.classList.add('hidden');
            resultAreaEl.classList.add('hidden');
            reviewAreaEl.classList.add('hidden');
            startPageEl.classList.remove('hidden');
            updateStartPageUI();

            const now = new Date();
            const dateOptions = { day: '2-digit', month: 'short', year: 'numeric' };
            const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: true };
            datetimeDisplay.innerText = `Date: ${now.toLocaleDateString('en-GB', dateOptions).replace(/ /g, '-').toUpperCase()} | Time: ${now.toLocaleTimeString('en-US', timeOptions)}`;
        }

        function startQuiz() {
            if (loadedQuestions.length === 0) {
                window.alert("There are no questions loaded.");
                return;
            }
            startPageEl.classList.add('hidden');
            questionAreaEl.classList.remove('hidden');
            navigationArea.classList.remove('hidden');
            shuffledQuestions = [...loadedQuestions].sort(() => Math.random() - 0.5);
            userAnswers = new Array(shuffledQuestions.length).fill(null);
            currentQuestionIndex = 0;
            score = 0;
            startExamTimer();
            showQuestion();
        }

        function showQuestion() {
            resetState();
            const currentQuestion = shuffledQuestions[currentQuestionIndex];
            questionNumberEl.innerText = `Question ${currentQuestionIndex + 1} of ${shuffledQuestions.length}`;
            questionTextEl.innerText = currentQuestion.question;
            currentQuestion.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.innerText = option;
                button.dataset.index = index; // Store the index for reliable answer checking
                button.classList.add('option-btn', 'w-full', 'text-left', 'p-4', 'border-2', 'border-gray-300', 'rounded-lg', 'hover:bg-gray-100', 'hover:border-indigo-500');
                button.addEventListener('click', selectAnswer);
                optionsContainerEl.appendChild(button);
            });
            updateProgressBar();
        }

        function startExamTimer() {
            totalTimeLeft = Math.round(loadedQuestions.length * 1.2 * 60);
            updateExamTimerDisplay();
            examTimer = setInterval(() => {
                totalTimeLeft--;
                updateExamTimerDisplay();
                if (totalTimeLeft <= 0) {
                    clearInterval(examTimer);
                    showResults();
                }
            }, 1000);
        }

        function updateExamTimerDisplay() {
            if (totalTimeLeft < 0) totalTimeLeft = 0;
            const hours = Math.floor(totalTimeLeft / 3600);
            const minutes = Math.floor((totalTimeLeft % 3600) / 60);
            const seconds = totalTimeLeft % 60;
            timerEl.innerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            timerEl.classList.toggle('text-red-600', totalTimeLeft <= 5 * 60);
        }
        
        function resetState() {
            nextBtn.disabled = true;
            while (optionsContainerEl.firstChild) {
                optionsContainerEl.removeChild(optionsContainerEl.firstChild);
            }
        }

        function selectAnswer(e) {
            const selectedBtn = e.target;
            Array.from(optionsContainerEl.children).forEach(btn => btn.classList.remove('selected'));
            selectedBtn.classList.add('selected');
            userAnswers[currentQuestionIndex] = parseInt(selectedBtn.dataset.index); // Store the selected index
            nextBtn.disabled = false;
        }

        function updateProgressBar() {
            const progress = ((currentQuestionIndex) / shuffledQuestions.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        async function showResults() {
            clearInterval(examTimer);
            score = shuffledQuestions.reduce((acc, q, i) => {
                const correctOptionIndex = getCorrectOptionIndex(q);
                return acc + (userAnswers[i] === correctOptionIndex ? 1 : 0);
            }, 0);
            progressBar.style.width = '100%';
            questionAreaEl.classList.add('hidden');
            navigationArea.classList.add('hidden');
            resultAreaEl.classList.remove('hidden');
            const scorePercent = Math.round((score / shuffledQuestions.length) * 100) || 0;
            scoreTextEl.innerText = `Your Score: ${score} out of ${shuffledQuestions.length} (${scorePercent}%)`;
            const passed = scorePercent >= 70;
            feedbackTextEl.innerText = passed ? "Congratulations! You passed." : "Keep studying! You'll get there.";
            feedbackTextEl.classList.toggle('text-green-600', passed);
            feedbackTextEl.classList.toggle('text-red-600', !passed);

            // Save history to database
            if (isDbReady) {
                try {
                    await historyCollectionRef.add({
                        title: loadedTitle,
                        score: score,
                        total: shuffledQuestions.length,
                        percentage: scorePercent,
                        result: passed ? "Pass" : "Fail",
                        date: new Date().toISOString()
                    });
                } catch (error) {
                    console.error("Error saving exam history:", error);
                }
            }
        }
        
        function showReview() {
            resultAreaEl.classList.add('hidden');
            reviewAreaEl.classList.remove('hidden');
            reviewContentEl.innerHTML = '';
            shuffledQuestions.forEach((q, i) => {
                const correctOptionIndex = getCorrectOptionIndex(q);
                const isCorrect = userAnswers[i] === correctOptionIndex;
                const userAnswerText = userAnswers[i] !== null ? q.options[userAnswers[i]] : 'No answer';
                const correctAnswerFullText = q.options[correctOptionIndex];
                const container = document.createElement('div');
                container.classList.add('review-question-container');
                container.innerHTML = `
                    <p class="text-lg font-semibold text-gray-800 mb-2">Q${i + 1}: ${q.question}</p>
                    <p class="text-sm p-3 border-2 rounded-lg mb-2 review-user-answer ${isCorrect ? 'correct' : 'incorrect'}">
                        <strong>Your Answer:</strong> ${userAnswerText}
                    </p>
                    ${!isCorrect ? `<p class="text-sm bg-green-50 p-3 border-2 border-green-200 rounded-lg mb-2">
                        <strong>Correct Answer:</strong> ${correctAnswerFullText}
                    </p>` : ''}
                    <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg"><strong>Explanation:</strong> ${q.explanation}</p>`;
                reviewContentEl.appendChild(container);
            });
        }

        function handleNextButton() {
            updateProgressBar();
            currentQuestionIndex++;
            if (currentQuestionIndex < shuffledQuestions.length) showQuestion();
            else showResults();
        }
        
        function downloadResults() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const now = new Date();
            const scorePercent = Math.round((score / shuffledQuestions.length) * 100) || 0;
            let y = 15;
            const margin = 15, pageHeight = doc.internal.pageSize.height, maxWidth = doc.internal.pageSize.width - margin * 2;
            
            const addFooter = () => {
                const pageCount = doc.internal.getNumberOfPages();
                doc.setFontSize(10);
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.width / 2, pageHeight - 10, { align: 'center' });
                }
            };

            doc.setFontSize(18);
            doc.text(loadedTitle, margin, y, { align: 'left' });
            y += 10;
            doc.setFontSize(12);
            doc.text(`Completed On: ${now.toLocaleString('en-IN')}`, margin, y);
            y += 7;
            doc.text(`Final Score: ${score}/${shuffledQuestions.length} (${scorePercent}%)`, margin, y);
            y += 10;

            shuffledQuestions.forEach((q, i) => {
                const correctOptionIndex = getCorrectOptionIndex(q);
                const isCorrect = userAnswers[i] === correctOptionIndex;
                const userAnswerText = userAnswers[i] !== null ? q.options[userAnswers[i]] : "N/A";
                const correctAnswerFullText = q.options[correctOptionIndex];
                
                const qLines = doc.splitTextToSize(`Q ${i + 1}: ${q.question}`, maxWidth - 2);
                const yourLines = doc.splitTextToSize(`Your Answer: ${userAnswerText}`, maxWidth - 10);
                
                const correctLines = doc.splitTextToSize(`Correct Answer: ${correctAnswerFullText}`, maxWidth - 10);
                
                const expLines = doc.splitTextToSize(`Explanation: ${q.explanation}`, maxWidth - 2);
                
                const contentHeight = (qLines.length + yourLines.length + correctLines.length + expLines.length) * 5 + 30;

                if (y + contentHeight > pageHeight - margin) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.text(qLines, margin + 1, y + 5);
                y += qLines.length * 5 + 5;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                doc.setDrawColor(isCorrect ? 10 : 239, isCorrect ? 185 : 68, isCorrect ? 135 : 68);
                doc.setFillColor(isCorrect ? 209 : 254, isCorrect ? 250 : 226, isCorrect ? 229 : 226);
                doc.roundedRect(margin, y, maxWidth, yourLines.length * 5 + 4, 3, 3, 'FD');
                doc.text(yourLines, margin + 2, y + 5);
                y += yourLines.length * 5 + 8;

                if (!isCorrect) {
                    doc.setDrawColor(209, 213, 219);
                    doc.setFillColor(249, 250, 251);
                    doc.roundedRect(margin, y, maxWidth, correctLines.length * 5 + 4, 3, 3, 'FD');
                    doc.text(correctLines, margin + 2, y + 5);
                    y += correctLines.length * 5 + 8;
                }
                
                doc.setFont(undefined, 'italic');
                doc.text(expLines, margin + 1, y + 5, { align: 'justify', maxWidth: maxWidth - 2 });
                y += expLines.length * 5 + 10;
            });
            
            addFooter();
            doc.save(`CISSP_Results_${now.toISOString().split('T')[0]}.pdf`);
        }

        // --- Question Management ---
        function getCorrectOptionIndex(question) {
            const answer = (question.answer || "").trim();
            if (answer.length === 1) { // It's a letter like "A", "B", etc.
                return answer.toUpperCase().charCodeAt(0) - 65;
            }
            // It's the full text, find the index
            return question.options.findIndex(opt => (opt || "").trim() === answer);
        }

        function validateQuestions(data) {
            return Array.isArray(data) && data.length > 0 && data.every(q => 
                typeof q === 'object' && q && 'question' in q && 'options' in q && 'answer' in q && 'explanation' in q && Array.isArray(q.options)
            );
        }
        
        function updateStartPageUI() {
            quizTitleEl.innerText = loadedTitle;
            const numQuestions = loadedQuestions.length;
            const timeEstimate = Math.round(numQuestions * 1.2); 
            startPageIntroEl.innerText = `This exam consists of ${numQuestions} questions. You will have approximately ${timeEstimate} minutes to complete it. Good luck!`;
        }

        function updateAdminStatus(message = '', isError = false) {
            questionLoadStatusEl.innerText = message;
            questionLoadStatusEl.classList.toggle('text-red-600', isError);
            questionLoadStatusEl.classList.toggle('text-green-600', !isError);
        }

        async function saveQuestionsToDb(questions, title) {
            if (!isDbReady) return updateAdminStatus("Database not ready. Please wait and try again.", true);
            try {
                const dataToSave = { 
                    title: title,
                    questionsJSON: JSON.stringify(questions) 
                };
                await questionsDocRef.set(dataToSave);
                updateAdminStatus(`Successfully saved ${questions.length} questions with title "${title}".`);
            } catch (error) {
                console.error("Error saving to Firestore:", error);
                updateAdminStatus(`Error saving to database: ${error.message}`, true);
            }
        }

        async function handleTextLoad() {
            const text = jsonTextareaEl.value;
            const title = examTitleInputEl.value.trim();
            if (!title) return updateAdminStatus('Please provide an exam title.', true);
            if (!text.trim()) return updateAdminStatus('Text area is empty.', true);
            try {
                const parsed = JSON.parse(text);
                if (validateQuestions(parsed)) {
                    await saveQuestionsToDb(parsed, title);
                    fileUploadEl.value = '';
                } else {
                    updateAdminStatus('Invalid JSON structure.', true);
                }
            } catch (error) {
                updateAdminStatus('Invalid JSON syntax.', true);
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            const title = examTitleInputEl.value.trim();
            if (!title) {
                updateAdminStatus('Please provide an exam title before uploading a file.', true);
                fileUploadEl.value = '';
                return;
            }
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const parsed = JSON.parse(e.target.result);
                    if (validateQuestions(parsed)) {
                        await saveQuestionsToDb(parsed, title);
                        jsonTextareaEl.value = '';
                    } else {
                        updateAdminStatus('Invalid JSON structure in file.', true);
                    }
                } catch (error) {
                    updateAdminStatus('Error parsing JSON file.', true);
                }
            };
            reader.readAsText(file);
        }

        async function handleFlushQuestions() {
             if (!isDbReady) return updateAdminStatus("Database not ready. Please wait and try again.", true);
            try {
                await questionsDocRef.delete();
                updateAdminStatus('Cleared custom questions. Quiz will now use defaults.');
                jsonTextareaEl.value = '';
                fileUploadEl.value = '';
                examTitleInputEl.value = '';
            } catch(error) {
                console.error("Error deleting from Firestore:", error);
                updateAdminStatus(`Error clearing questions: ${error.message}`, true);
            }
        }
        
        function handlePasswordSubmit() {
            const password = passwordInputEl.value;
            if (password === "Legacy@2025") {
                passwordPageEl.classList.add('hidden');
                adminMenuPageEl.classList.remove('hidden');
                passwordErrorEl.innerText = '';
                passwordInputEl.value = '';
            } else {
                passwordErrorEl.innerText = 'Incorrect password. Please try again.';
            }
        }
        
        function displayExamHistory(history) {
            examHistoryContainerEl.innerHTML = '';
            if (history.length === 0) {
                examHistoryContainerEl.innerHTML = '<p class="text-center text-gray-500">No exam history found.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-gray-500';
            table.innerHTML = `
                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-2">Exam Title</th>
                        <th scope="col" class="px-4 py-2 text-center">Score</th>
                        <th scope="col" class="px-4 py-2 text-center">Percentage</th>
                        <th scope="col" class="px-4 py-2 text-center">Result</th>
                        <th scope="col" class="px-4 py-2 text-center">Date</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');
            history.forEach(entry => {
                const row = tbody.insertRow();
                const date = new Date(entry.date).toLocaleString('en-IN');
                const resultClass = entry.result === 'Pass' ? 'text-green-600 font-semibold' : 'text-red-600 font-semibold';
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-4 py-2 font-medium text-gray-900">${entry.title}</td>
                    <td class="px-4 py-2 text-center">${entry.score} / ${entry.total}</td>
                    <td class="px-4 py-2 text-center">${entry.percentage}%</td>
                    <td class="px-4 py-2 text-center ${resultClass}">${entry.result}</td>
                    <td class="px-4 py-2 text-center">${date}</td>
                `;
            });
            examHistoryContainerEl.appendChild(table);
        }

        async function handleClearHistory() {
            if (!isDbReady) {
                updateAdminStatus("Database not ready. Please wait and try again.", true);
                return;
            }
            if (!confirm("Are you sure you want to delete all exam history? This action cannot be undone.")) return;

            try {
                const snapshot = await historyCollectionRef.get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                // The onSnapshot listener will automatically update the UI, but we can give feedback.
                updateAdminStatus("Successfully cleared exam history.");
                // We need to manually refresh the view if there's no listener on this page
                displayExamHistory([]); // Immediately clear the view
            } catch (error) {
                console.error("Error clearing history:", error);
                updateAdminStatus(`Error clearing history: ${error.message}`, true);
            }
        }

        // --- Event Listeners ---
        startExamBtn.addEventListener('click', startQuiz);
        nextBtn.addEventListener('click', handleNextButton);
        restartBtn.addEventListener('click', initializeQuiz);
        reviewBtn.addEventListener('click', showReview);
        downloadBtn.addEventListener('click', downloadResults);
        backToScoreBtn.addEventListener('click', () => {
            reviewAreaEl.classList.add('hidden');
            resultAreaEl.classList.remove('hidden');
        });
        
        fileUploadEl.addEventListener('change', handleFileUpload);
        loadTextBtn.addEventListener('click', handleTextLoad);
        flushQuestionsBtn.addEventListener('click', handleFlushQuestions);
        passwordSubmitBtn.addEventListener('click', handlePasswordSubmit);
        passwordInputEl.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handlePasswordSubmit();
            }
        });
        clearHistoryBtn.addEventListener('click', handleClearHistory);
        
        window.addEventListener('hashchange', router);
        window.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
            router();
        });
    });
    </script>
</body>
</html>
